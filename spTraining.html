<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV Attendance Report Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style>
      body {
        background-color: #f7f9fb;
        font-family: "Inter", sans-serif;
      }
      .container-box {
        background-color: #ffffff;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1);
      }
      .csv-output {
        white-space: pre;
        overflow-x: auto;
        min-height: 200px;
        font-family: monospace;
      }
      .date-checkbox:checked + div {
        background-color: #e0e7ff;
        border-color: #4f46e5;
        color: #4f46e5;
      }
      .division-checkbox:checked + div {
        background-color: #dcfce7;
        border-color: #16a34a;
        color: #16a34a;
      }
    </style>
  </head>
  <body class="p-4 sm:p-8">
    <div class="max-w-5xl mx-auto space-y-6">
      <!-- Header -->
      <div class="border-b pb-4">
        <h1 class="text-3xl font-bold text-gray-800">
          Chinese Chess Attendance Report Generator
        </h1>
        <p class="text-gray-600 mt-2">
          Upload CSV, select dates and divisions, then generate your report
        </p>
      </div>

      <!-- Step 1: File Upload -->
      <div class="container-box p-6 rounded-lg">
        <h2 class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
          <span
            class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm mr-3"
            >1</span
          >
          Upload CSV File
        </h2>
        <div class="flex flex-col sm:flex-row gap-4 items-start">
          <input
            type="file"
            id="csvFile"
            accept=".csv"
            class="flex-grow text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 border border-gray-300 rounded-lg p-2"
          />
          <button
            onclick="analyzeCSV()"
            id="analyzeButton"
            class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-full hover:bg-indigo-700 transition duration-150 shadow-md whitespace-nowrap"
          >
            Analyze File
          </button>
        </div>
        <p id="uploadMessage" class="mt-3 text-sm hidden"></p>
      </div>

      <!-- Step 2: Date & Division Selection (Hidden initially) -->
      <div id="selectionPanel" class="hidden container-box p-6 rounded-lg">
        <h2 class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
          <span
            class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm mr-3"
            >2</span
          >
          Select Dates & Divisions
        </h2>

        <!-- Division Filter -->
        <div class="mb-6">
          <h3
            class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-3"
          >
            Divisions Found
          </h3>
          <div id="divisionContainer" class="flex flex-wrap gap-2">
            <!-- Checkboxes injected here -->
          </div>
          <p class="text-xs text-gray-500 mt-2">
            Select which divisions to include in the report
          </p>
        </div>

        <!-- Date Filter -->
        <div class="mb-6">
          <div class="flex justify-between items-center mb-3">
            <h3
              class="text-sm font-semibold text-gray-600 uppercase tracking-wide"
            >
              Available Dates
            </h3>
            <div class="space-x-2">
              <button
                onclick="selectAllDates(true)"
                class="text-xs text-indigo-600 hover:text-indigo-800 font-medium"
              >
                Select All
              </button>
              <button
                onclick="selectAllDates(false)"
                class="text-xs text-gray-500 hover:text-gray-700 font-medium"
              >
                Clear
              </button>
            </div>
          </div>
          <div id="dateContainer" class="space-y-4">
            <!-- Date checkboxes grouped by month -->
          </div>
        </div>

        <div class="flex justify-end pt-4 border-t">
          <button
            onclick="generateReport()"
            id="generateButton"
            class="px-8 py-3 bg-green-600 text-white font-semibold rounded-full hover:bg-green-700 transition duration-150 shadow-md flex items-center gap-2"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              ></path>
            </svg>
            Generate Report
          </button>
        </div>
      </div>

      <!-- Step 3: Output -->
      <div id="outputPanel" class="hidden container-box p-6 rounded-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-700">Generated Report</h2>
          <div class="text-sm text-gray-600" id="reportSummary"></div>
        </div>

        <textarea
          id="csvOutput"
          readonly
          placeholder="Report will appear here..."
          class="csv-output w-full p-4 border border-gray-300 rounded-lg bg-gray-50 text-sm text-gray-800 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 mb-4"
          rows="10"
        ></textarea>

        <div class="flex justify-end">
          <button
            onclick="downloadCSV()"
            id="downloadButton"
            class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-full hover:bg-indigo-700 transition duration-150 shadow-md flex items-center gap-2"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
              ></path>
            </svg>
            Download CSV
          </button>
        </div>
      </div>
    </div>

    <script>
      // Global storage for parsed data
      let parsedData = [];
      let availableDates = new Map(); // Map<dateString, {sortKey, display, month, count}>
      let availableDivisions = new Map();

      // --- Utility Functions ---

      function parseCSV(text) {
        const rows = text.trim().split("\n");
        if (rows.length === 0) return [];

        const data = [];
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          if (row.trim() === "") continue;

          const values = [];
          let inQuote = false;
          let current = "";

          for (let j = 0; j < row.length; j++) {
            const char = row[j];

            if (char === '"') {
              if (inQuote && j + 1 < row.length && row[j + 1] === '"') {
                current += '"';
                j++;
              } else {
                inQuote = !inQuote;
              }
            } else if (char === "," && !inQuote) {
              values.push(current.trim());
              current = "";
            } else {
              current += char;
            }
          }
          values.push(current.trim());

          const cleanedValues = values.map((v) =>
            v.replace(/^"|"$/g, "").trim(),
          );
          data.push(cleanedValues);
        }
        return data;
      }

      function parseDate(dateStr) {
        const parts = dateStr.split("/");
        if (parts.length !== 3) return null;

        const [day, month, year] = parts;
        const date = new Date(year, month - 1, day);

        if (isNaN(date)) return null;

        return {
          sortKey: `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}`,
          display: `${date.toLocaleString("en-US", { month: "short" })}-${day.padStart(2, "0")}`,
          fullDate: date,
          original: dateStr,
        };
      }

      function showMessage(elementId, message, isError = false) {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.className = `mt-3 text-sm ${isError ? "text-red-600 font-medium" : "text-green-600 font-medium"}`;
        el.classList.remove("hidden");
      }

      // --- Step 1: Analyze CSV ---

      function analyzeCSV() {
        const fileInput = document.getElementById("csvFile");
        const file = fileInput.files[0];

        if (!file) {
          showMessage("uploadMessage", "Please select a CSV file first.", true);
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const rawData = e.target.result;
            parsedData = parseCSV(rawData);

            if (parsedData.length === 0) {
              showMessage(
                "uploadMessage",
                "CSV file is empty or unreadable.",
                true,
              );
              return;
            }

            extractMetadata();

            if (availableDates.size === 0) {
              showMessage(
                "uploadMessage",
                "No valid dates found in CSV.",
                true,
              );
              return;
            }

            renderDivisionSelectors();
            renderDateSelectors();
            document
              .getElementById("selectionPanel")
              .classList.remove("hidden");
            document.getElementById("outputPanel").classList.add("hidden");

            showMessage(
              "uploadMessage",
              `Found ${parsedData.length} records across ${availableDates.size} dates and ${availableDivisions.size} divisions.`,
            );
          } catch (error) {
            console.error(error);
            showMessage(
              "uploadMessage",
              "Error parsing CSV: " + error.message,
              true,
            );
          }
        };

        reader.readAsText(file);
      }

      function extractMetadata() {
        availableDates.clear();
        availableDivisions.clear();

        const DATE_INDEX = 6;
        const DIVISION_INDEX = 11;

        parsedData.forEach((row) => {
          if (row.length > DATE_INDEX && row[DATE_INDEX]) {
            const dateStr = row[DATE_INDEX];
            const parsed = parseDate(dateStr);

            if (parsed) {
              if (!availableDates.has(dateStr)) {
                availableDates.set(dateStr, {
                  ...parsed,
                  count: 0,
                  divisions: new Set(),
                });
              }
              availableDates.get(dateStr).count++;
            }
          }

          if (row.length > DIVISION_INDEX && row[DIVISION_INDEX]) {
            const div = row[DIVISION_INDEX].trim();
            if (div) {
              if (!availableDivisions.has(div)) {
                availableDivisions.set(div, 0);
              }
              availableDivisions.set(div, availableDivisions.get(div) + 1);
            }
          }
        });

        availableDates = new Map(
          [...availableDates].sort((a, b) =>
            a[1].sortKey.localeCompare(b[1].sortKey),
          ),
        );
      }

      // --- Step 2: Render Selectors ---

      function renderDivisionSelectors() {
        const container = document.getElementById("divisionContainer");
        container.innerHTML = "";

        const sortedDivisions = [...availableDivisions.keys()].sort((a, b) =>
          a.localeCompare(b),
        );

        sortedDivisions.forEach((division) => {
          const count = availableDivisions.get(division);
          const isChecked = division === "Chinese Chess" ? "checked" : "";

          const label = document.createElement("label");
          label.className = "cursor-pointer";
          label.innerHTML = `
            <input type="checkbox" class="division-checkbox hidden" value="${division}" ${isChecked}>
            <div class="px-4 py-2 rounded-full border border-gray-300 bg-gray-50 text-sm font-medium transition-all hover:bg-gray-100 flex items-center gap-2">
              <span>${division}</span>
              <span class="text-xs opacity-60 bg-white px-2 py-0.5 rounded-full">${count}</span>
            </div>
          `;
          container.appendChild(label);
        });
      }

      function renderDateSelectors() {
        const container = document.getElementById("dateContainer");
        container.innerHTML = "";

        const monthGroups = new Map();
        availableDates.forEach((data, dateStr) => {
          const monthKey = data.sortKey.substring(0, 7); // YYYY-MM
          if (!monthGroups.has(monthKey)) {
            monthGroups.set(monthKey, {
              month: data.fullDate.toLocaleString("en-US", {
                month: "long",
                year: "numeric",
              }),
              dates: [],
            });
          }
          monthGroups.get(monthKey).dates.push({ dateStr, ...data });
        });

        const sortedMonths = [...monthGroups.keys()].sort();

        sortedMonths.forEach((monthKey) => {
          const group = monthGroups.get(monthKey);

          const monthDiv = document.createElement("div");
          monthDiv.className =
            "border border-gray-200 rounded-lg p-4 bg-gray-50";

          const header = document.createElement("div");
          header.className = "flex justify-between items-center mb-3";
          header.innerHTML = `
            <h4 class="font-semibold text-gray-700">${group.month}</h4>
            <span class="text-xs text-gray-500">${group.dates.length} date(s)</span>
          `;
          monthDiv.appendChild(header);

          const datesGrid = document.createElement("div");
          datesGrid.className = "flex flex-wrap gap-2";

          group.dates.forEach(({ dateStr, display, count }) => {
            const label = document.createElement("label");
            label.className = "cursor-pointer";
            label.title = `${count} records on ${display}`;
            label.innerHTML = `
              <input type="checkbox" class="date-checkbox hidden" value="${dateStr}" checked>
              <div class="px-3 py-1.5 rounded border border-gray-300 bg-white text-sm transition-all hover:bg-gray-50 flex flex-col items-center min-w-[4.5rem]">
                <span class="font-semibold">${display}</span>
                <span class="text-xs opacity-60">${count} rec</span>
              </div>
            `;
            datesGrid.appendChild(label);
          });

          monthDiv.appendChild(datesGrid);
          container.appendChild(monthDiv);
        });
      }

      function selectAllDates(select) {
        document.querySelectorAll(".date-checkbox").forEach((cb) => {
          cb.checked = select;
        });
      }

      // --- Step 3: Generate Report ---

      function generateReport() {
        const selectedDivisions = new Set();
        document
          .querySelectorAll(".division-checkbox:checked")
          .forEach((cb) => {
            selectedDivisions.add(cb.value.toLowerCase());
          });

        if (selectedDivisions.size === 0) {
          alert("Please select at least one division.");
          return;
        }

        const selectedDates = new Set();
        document.querySelectorAll(".date-checkbox:checked").forEach((cb) => {
          selectedDates.add(cb.value);
        });

        if (selectedDates.size === 0) {
          alert("Please select at least one date.");
          return;
        }

        const ADMIN_INDEX = 4;
        const NAME_INDEX = 3;
        const ACTIVITY_TYPE_INDEX = 5;
        const DATE_INDEX = 6;
        const DIVISION_INDEX = 11;

        const filteredRecords = parsedData.filter((row) => {
          if (row.length <= DIVISION_INDEX) return false;

          const isTraining =
            row[ACTIVITY_TYPE_INDEX] &&
            row[ACTIVITY_TYPE_INDEX].toLowerCase() === "training/workshop";
          const division = row[DIVISION_INDEX]
            ? row[DIVISION_INDEX].toLowerCase()
            : "";
          const isSelectedDivision = selectedDivisions.has(division);
          const date = row[DATE_INDEX];
          const isSelectedDate = selectedDates.has(date);

          return isTraining && isSelectedDivision && isSelectedDate;
        });

        if (filteredRecords.length === 0) {
          alert("No records found matching the selected criteria.");
          return;
        }

        // Build attendance map - FIX: Store display info with sortKey
        const studentMap = new Map();
        const dateMap = new Map(); // sortKey -> display

        filteredRecords.forEach((row) => {
          const adminNo = row[ADMIN_INDEX];
          const name = row[NAME_INDEX];
          const dateStr = row[DATE_INDEX];

          if (!adminNo || !name || !dateStr) return;

          const parsed = parseDate(dateStr);
          if (!parsed) return;

          // Store the display for this sortKey
          dateMap.set(parsed.sortKey, parsed.display);

          if (!studentMap.has(adminNo)) {
            studentMap.set(adminNo, {
              name: name.replace(/^"|"$/g, ""),
              attendance: new Map(),
            });
          }

          studentMap.get(adminNo).attendance.set(parsed.sortKey, 1);
        });

        const sortedDates = Array.from(dateMap.keys()).sort();

        const outputRows = [];
        const sortedAdmins = Array.from(studentMap.keys()).sort();

        sortedAdmins.forEach((adminNo) => {
          const student = studentMap.get(adminNo);
          let attendedCount = 0;
          const dateColumns = [];

          sortedDates.forEach((dateKey) => {
            const attended = student.attendance.has(dateKey) ? 1 : 0;
            dateColumns.push(attended);
            attendedCount += attended;
          });

          const percentage =
            sortedDates.length > 0
              ? Math.round((attendedCount / sortedDates.length) * 100)
              : 0;

          outputRows.push([
            adminNo,
            student.name,
            attendedCount,
            percentage + "%",
            ...dateColumns,
          ]);
        });

        // FIX: Use the stored display names instead of reparsing
        const dateHeaders = sortedDates.map((sortKey) => dateMap.get(sortKey));

        const header1 = [
          "Admin Number",
          "Name",
          "Total",
          "Percentage",
          "Attended",
          ...Array(dateHeaders.length - 1).fill(""),
        ];
        const header2 = ["", "", "", "", ...dateHeaders];

        const csvContent = [
          header1.join(","),
          header2.join(","),
          ...outputRows.map((row) => row.join(",")),
        ].join("\n");

        document.getElementById("csvOutput").value = csvContent;
        document.getElementById("outputPanel").classList.remove("hidden");
        document.getElementById("reportSummary").textContent =
          `${outputRows.length} students | ${sortedDates.length} dates | ${filteredRecords.length} total records`;

        document
          .getElementById("outputPanel")
          .scrollIntoView({ behavior: "smooth" });
      }

      function downloadCSV() {
        const csvText = document.getElementById("csvOutput").value;
        if (!csvText) {
          alert("No data to download.");
          return;
        }

        const blob = new Blob([csvText], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);

        const date = new Date().toISOString().split("T")[0];
        link.setAttribute("href", url);
        link.setAttribute("download", `attendance_report_${date}.csv`);
        link.style.visibility = "hidden";

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    </script>
  </body>
</html>
